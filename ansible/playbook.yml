- hosts: localhost
  become: yes
  vars_files:
    - vars/monitoring.yml

  collections:
    - community.docker

  tasks:
    - name: Remove APT-installed python3-docker to avoid vendored SDK conflicts
      apt:
        name: python3-docker
        state: absent

    - name: Install Docker SDK for Python via pip
      pip:
        name:
          - docker==6.0.0            # Pin to a compatible version
          - requests<2.32.0         # Ensure requests compatibility
        executable: pip3

    - name: Ensure Docker is installed
      apt:
        name: docker.io
        state: present

    - name: Ensure Docker is running and enabled
      service:
        name: docker
        state: started
        enabled: yes

    - name: Create monitoring network
      community.docker.docker_network:
        name: "{{ docker_network }}"

    - name: Create Prometheus config directory
      file:
        path: "{{ prometheus.config_dir }}"
        state: directory
        mode: '0755'

    - name: Copy Prometheus configuration
      copy:
        src: files/{{ prometheus.config_file }}
        dest: "{{ prometheus.config_dir }}/{{ prometheus.config_file }}"

    - name: Deploy Prometheus
      docker_container:
        name: "{{ prometheus.container_name }}"
        image: "{{ prometheus.image }}"
        state: started
        restart_policy: unless-stopped
        networks:
          - name: "{{ docker_network }}"
        ports:
          - "{{ prometheus.port }}:{{ prometheus.port }}"
        volumes:
          - "{{ prometheus.volume_path }}:/etc/prometheus/{{ prometheus.config_file }}"

    - name: Create Grafana data directory
      file:
        path: "{{ grafana.data_dir }}"
        state: directory
        mode: '0755'

    - name: Deploy Grafana
      docker_container:
        name: "{{ grafana.container_name }}"
        image: "{{ grafana.image }}"
        state: started
        restart_policy: unless-stopped
        networks:
          - name: "{{ docker_network }}"
        ports:
          - "{{ grafana.port }}:{{ grafana.port }}"
        volumes:
          - "{{ grafana.data_dir }}:/var/lib/grafana"